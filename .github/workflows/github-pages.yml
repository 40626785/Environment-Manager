name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, feature/github-pages ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install DocFX
        run: dotnet tool install -g docfx

      - name: Create temporary docfx.json
        run: |
          cat > docfx.temp.json << 'EOF'
          {
            "metadata": [],
            "build": {
              "content": [
                {
                  "files": [
                    "articles/**.md",
                    "articles/**/toc.yml",
                    "toc.yml",
                    "*.md"
                  ]
                }
              ],
              "resource": [
                {
                  "files": [
                    "images/**"
                  ]
                }
              ],
              "dest": "_site",
              "globalMetadata": {
                "_appTitle": "Environment Manager",
                "_enableSearch": true,
                "_enableNewTab": true,
                "_gitContribute": {
                  "repo": "https://github.com/40626785/Environment-Manager",
                  "branch": "main"
                }
              },
              "template": [
                "default",
                "modern"
              ],
              "postProcessors": [],
              "markdownEngineName": "markdig",
              "noLangKeyword": false,
              "keepFileLink": false,
              "cleanupCacheHistory": false,
              "disableGitFeatures": false
            }
          }
          EOF

      - name: Build Documentation
        run: docfx docfx.temp.json

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 